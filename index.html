<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DINARPUS - Sistem Laporan Kinerja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; padding: 0; margin: 0; }
            .signature-wrapper { display: flex !important; flex-direction: row !important; justify-content: space-between !important; margin-top: 50px; }
            .signature-box { width: 45% !important; text-align: center; }
            table { width: 100% !important; border-collapse: collapse; table-layout: fixed; }
            th, td { border: 1px solid black !important; padding: 8px !important; word-wrap: break-word; }
        }
        .print-only { display: none; }
        #signature-pad-canvas { border: 2px dashed #cbd5e1; background: #f8fafc; cursor: crosshair; }
        .signature-img { max-height: 80px; mix-blend-mode: multiply; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        
        /* Animasi Notifikasi */
        .toast-notif { animation: slideIn 0.5s ease-out forwards; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="notifContainer" class="fixed bottom-5 right-5 z-[100] space-y-3 pointer-events-none"></div>

    <div id="loginPage" class="flex items-center justify-center min-h-screen no-print px-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border-t-8 border-blue-900">
            <h1 class="text-3xl font-black text-blue-900 text-center mb-6 italic uppercase">Laporan Kinerja Dinarpus PPPK PW</h1>
            <div class="space-y-4">
                <select id="userSelect" class="w-full p-3 border rounded-xl outline-none bg-gray-50 focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                    <option value="">-- Pilih User --</option>
                    <option value="Saeful">Saeful (Pegawai)</option>
                    <option value="Fuad">Fuad (Pegawai)</option>
                    <option value="Lusi">Lusi (Pegawai)</option>
                    <option value="Dadi">Dadi (Pegawai)</option>
                    <option value="Widhi">Widhi (Pegawai)</option>
                    <option value="Eni">Eni (Pegawai)</option>
                    <option value="Della">Della (Pegawai)</option>
                    <option value="Arya">Arya (Pegawai)</option>
                    <option value="Ragil">Ragil Aji (Pegawai)</option>
                    <option value="Parsono">Parsono (Pegawai)</option>
                    <option value="Agus">Agus (Pegawai)</option>
                    <option value="Mijil">Mijil (Pegawai)</option>
                    <option value="Dirin">Dirin (Pegawai)</option>
                    <option value="Toro">Toro (Pegawai)</option>
                    <option value="Ana">Ana (Pegawai)</option>
                    <option value="Mei">Mei (Pegawai)</option>
                    <option value="Okta">Okta (Pegawai)</option>
                    <option value="Bella">Bella (Pegawai)</option>
                    <option value="Arfan">Arfan (Pegawai)</option>
                    <option value="Didid">Didid (Pegawai)</option>
                    <option value="Lia">Lia (Pegawai)</option>
                    <option value="Riono">Riono (Pegawai)</option>
                    <option value="Hari">Hari (Pegawai)</option>
                    <option value="Novi">Novi (Pegawai)</option>
                    <option value="Murti">Murtikowati (Verifikator)</option>
                    <option value="Itqon">M.Nur Itqon (Verifikator)</option>
                    <option value="Marliati">Marliati (Verifikator)</option>
                    <option value="Kepala">Endi Astono (Pimpinan)</option>
                </select>
                <input type="password" id="passInput" placeholder="Password" class="w-full p-3 border rounded-xl outline-none bg-gray-50 focus:ring-2 focus:ring-blue-500 text-sm">
                <button onclick="handleLogin()" class="w-full bg-blue-900 text-white font-bold py-3 rounded-xl hover:bg-black transition shadow-lg">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <nav class="bg-blue-900 text-white p-4 no-print flex justify-between items-center shadow-md">
            <div class="font-black text-xl italic tracking-tighter uppercase">DINARPUS PW 2026</div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p id="displayUser" class="text-xs font-bold"></p>
                    <p id="displayRole" class="text-[10px] text-blue-300 uppercase font-black"></p>
                </div>
                <button onclick="handleLogout()" class="bg-red-500 p-2 rounded-lg text-[10px] font-bold">LOGOUT</button>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-4 md:p-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 no-print border flex flex-wrap items-end gap-4">
                <div class="flex-1 min-w-[200px]">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Periode Laporan</label>
                    <div class="flex gap-2 items-center">
                        <input type="date" id="filterStart" class="border p-2 rounded-lg bg-slate-50 w-full text-sm">
                        <span class="text-xs">s/d</span>
                        <input type="date" id="filterEnd" class="border p-2 rounded-lg bg-slate-50 w-full text-sm">
                    </div>
                </div>
                <button onclick="renderTable()" class="bg-blue-800 text-white px-6 py-2 rounded-lg font-bold text-sm">Tampilkan</button>
                <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold text-sm">CETAK PDF</button>
            </div>

            <div id="formPegawai" class="hidden bg-white p-6 rounded-2xl shadow-sm mb-6 no-print border-l-8 border-blue-700">
                <h2 id="formTitle" class="font-bold text-slate-800 mb-1 uppercase text-xs tracking-widest">Tambah Kegiatan</h2>
                <p class="text-[10px] text-red-600 font-bold mb-4 uppercase italic">* Batas Input: Hari ini maks jam 16.00 WIB</p>
                <input type="hidden" id="editId">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Tanggal</label>
                        <input type="date" id="inTgl" class="w-full border p-3 rounded-xl text-sm bg-gray-100 mt-1" readonly>
                    </div>
                    <div class="md:col-span-3">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Uraian Kegiatan</label>
                        <textarea id="inUraian" rows="3" class="w-full border p-3 rounded-xl text-sm bg-slate-50 mt-1 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Volume & Satuan</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" id="inJml" placeholder="Jml" class="border p-3 rounded-xl text-sm w-20 bg-slate-50">
                            <input type="text" id="inSatuan" placeholder="Satuan" class="border p-3 rounded-xl text-sm w-full bg-slate-50">
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Upload Bukti (Max 5Mb)</label>
                        <input type="file" id="inBerkas" class="w-full text-xs mt-1 border p-2 rounded-xl bg-slate-50">
                    </div>
                    <div class="flex items-end">
                        <button onclick="submitLaporan()" class="w-full bg-blue-700 text-white py-3 rounded-xl font-bold uppercase hover:bg-black transition shadow-md">Simpan</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border p-4 md:p-8">
                <div class="print-only text-center border-b-4 border-double border-black pb-4 mb-8">
                    <h1 class="text-2xl font-black uppercase">LAPORAN KINERJA HARIAN</h1>
                    <h2 class="text-lg font-bold uppercase">DINAS KEARSIPAN DAN PERPUSTAKAAN</h2>
                </div>

                <table class="w-full text-xs text-left border-collapse border">
                    <thead>
                        <tr class="bg-slate-100 text-slate-600 uppercase font-black border">
                            <th class="p-3 border text-center w-10">No</th>
                            <th class="p-2 border">Nama</th>
                            <th class="p-2 border">Tanggal</th>
                            <th class="p-3 border">Uraian Kegiatan</th>
                            <th class="p-3 border text-center">Volume</th>
                            <th class="p-3 border text-center">Bukti</th>
                            <th class="p-3 border text-center">Tanda Tangan</th>
                            <th class="p-3 border text-center no-print">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>

                <div class="print-only signature-wrapper">
                    <div class="signature-box">
                        <p class="text-xs mb-16 font-bold uppercase">Verifikator ,</p>
                        <img id="printSignVerif" class="signature-img mx-auto">
                        <p id="printNameVerif" class="font-bold underline uppercase text-sm mt-2"></p>
                    </div>
                    <div class="signature-box">
                        <p class="text-xs mb-16 font-bold uppercase">Mengesahkan,</p>
                        <img id="printSignPimpinan" class="signature-img mx-auto">
                        <p class="font-bold underline uppercase text-sm mt-2">ENDI ASTONO, S.Sos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="signModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md text-center">
            <h3 class="text-lg font-bold mb-4 italic uppercase">Goreskan Tanda Tangan</h3>
            <canvas id="signature-pad-canvas" width="400" height="200" class="w-full rounded-lg"></canvas>
            <div class="flex gap-2 mt-4">
                <button onclick="clearSign()" class="bg-gray-100 px-4 py-2 rounded-xl text-xs font-bold uppercase">Ulangi</button>
                <button onclick="saveSign()" class="bg-blue-800 text-white flex-1 py-2 rounded-xl font-bold uppercase">Simpan TTD</button>
                <button onclick="closeModal()" class="text-red-500 text-xs px-2 font-bold uppercase">Batal</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAi6r89ZlhtZ325z3ypGQhrKUdq-mHXNCs",
            authDomain: "laporankinerja-fa09e.firebaseapp.com",
            databaseURL: "https://laporankinerja-fa09e-default-rtdb.firebaseio.com",
            projectId: "laporankinerja-fa09e",
            storageBucket: "laporankinerja-fa09e.firebasestorage.app",
            messagingSenderId: "1034616765062",
            appId: "1:1034616765062:web:ad66fa6c34dfadcec52f07"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('dinarpus_db');

        // --- 2. CONFIG USERS ---
        const config = {
            'Murti': { role: 'Verifikator', pass: '12345' },
            'Marliati': { role: 'Verifikator', pass: '12345' },
            'Itqon': { role: 'Verifikator', pass: '12345' },
            'Kepala': { role: 'Pimpinan', pass: '123456' },
            'Saeful': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Fuad': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Lusi': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Dadi': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Widhi': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Eni': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Arya': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Della': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Novi': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Parsono': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Riono': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Hari': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Agus': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Mijil': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Dirin': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Toro': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Ana': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Mei': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Okta': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Bella': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Arfan': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Didid': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Lia': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Ragil': { role: 'Pegawai', verif: 'Itqon', pass: '123' }
        };

        let db = [];
        let userSess = null;
        let signPad = null;
        let activeId = null;

        // --- 3. CORE FUNCTIONS ---
        document.addEventListener('DOMContentLoaded', () => {
            signPad = new SignaturePad(document.getElementById('signature-pad-canvas'));
            const saved = localStorage.getItem('dinarpus_session');
            if (saved) {
                userSess = JSON.parse(saved);
                renderDashboard();
            }
        });

        function handleLogin() {
            const user = document.getElementById('userSelect').value;
            const pass = document.getElementById('passInput').value;
            if (!user || !config[user] || pass !== config[user].pass) return alert("User/Password Salah!");
            
            userSess = { name: user, ...config[user] };
            localStorage.setItem('dinarpus_session', JSON.stringify(userSess));
            renderDashboard();
        }

        function handleLogout() {
            localStorage.removeItem('dinarpus_session');
            location.reload();
        }

        function renderDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('displayUser').innerText = userSess.name;
            document.getElementById('displayRole').innerText = userSess.role;

            if (userSess.role === 'Pegawai') {
                document.getElementById('formPegawai').classList.remove('hidden');
                document.getElementById('inTgl').value = new Date().toISOString().split('T')[0];
            }
            muatDataOnline();
            aktifkanNotifRealtime();
        }

        function muatDataOnline() {
            dbRef.on('value', (snap) => {
                const data = snap.val();
                db = data ? Object.values(data) : [];
                renderTable();
            });
        }

        function submitLaporan() {
            // CEK WAKTU (Maksimal Jam 16.00)
            const skr = new Date();
            if (skr.getHours() >= 16) return alert("Maaf, sistem sudah terkunci. Batas input adalah Jam 16.00 WIB.");

            const editId = document.getElementById('editId').value;
            const file = document.getElementById('inBerkas').files[0];

            const executeSave = (imgBase64 = "") => {
                const id = editId || Date.now();
                const currentData = editId ? db.find(x => x.id == editId) : null;

                const data = {
                    id: id,
                    user: userSess.name,
                    verifBy: userSess.verif || '',
                    tgl: document.getElementById('inTgl').value,
                    uraian: document.getElementById('inUraian').value,
                    jml: document.getElementById('inJml').value,
                    satuan: document.getElementById('inSatuan').value,
                    status: currentData ? currentData.status : 'INPUT',
                    signV: currentData ? (currentData.signV || '') : '',
                    signP: currentData ? (currentData.signP || '') : '',
                    berkas: imgBase64 || (currentData ? currentData.berkas : '')
                };

                dbRef.child(id).set(data).then(() => {
                    alert("Berhasil Disimpan!");
                    resetForm();
                });
            };

            if (file) {
                if (file.size > 5000000) return alert("File terlalu besar (Maks 5Mb)");
                const r = new FileReader();
                r.readAsDataURL(file);
                r.onload = () => executeSave(r.result);
            } else {
                executeSave();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const fStart = document.getElementById('filterStart').value;
            const fEnd = document.getElementById('filterEnd').value;
            tbody.innerHTML = '';

            db.filter(i => {
                const rM = (userSess.role === 'Pegawai') ? (i.user === userSess.name) :
                           (userSess.role === 'Verifikator') ? (i.verifBy === userSess.name) : true;
                const dM = (fStart && fEnd) ? (i.tgl >= fStart && i.tgl <= fEnd) : true;
                return rM && dM;
            }).sort((a,b) => b.id - a.id).forEach((i, idx) => {
                const hari = new Date(i.tgl).toLocaleDateString('id-ID', {weekday: 'long'});
                let aksi = '', signImg = '<span class="text-gray-300 italic">Proses</span>';

                if (i.status === 'VERIFIED') signImg = `<img src="${i.signV}" class="h-10 mx-auto">`;
                if (i.status === 'FINISHED') signImg = `<img src="${i.signP}" class="h-10 mx-auto">`;

                if (userSess.role === 'Pegawai' && i.status === 'INPUT') {
                    aksi = `<button onclick="editData(${i.id})" class="text-blue-600 font-bold mr-2">Edit</button>
                            <button onclick="hapusData(${i.id})" class="text-red-600 font-bold">Hapus</button>`;
                } else if (userSess.role === 'Verifikator' && i.status === 'INPUT') {
                    aksi = `<button onclick="openSign(${i.id})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold">VERIFIKASI</button>`;
                } else if (userSess.role === 'Pimpinan' && i.status === 'VERIFIED') {
                    aksi = `<button onclick="openSign(${i.id})" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold">TANDA TANGAN</button>`;
                }

                tbody.innerHTML += `
                    <tr class="border hover:bg-slate-50">
                        <td class="p-3 border text-center">${idx+1}</td>
                        <td class="p-2 border font-bold text-blue-900">${i.user}</td>
                        <td class="p-2 border">${hari}, ${i.tgl}</td>
                        <td class="p-2 border whitespace-pre-wrap">${i.uraian}</td>
                        <td class="p-2 border text-center font-bold">${i.jml} ${i.satuan}</td>
                        <td class="p-2 border text-center">${i.berkas ? `<a href="${i.berkas}" download="bukti-${i.id}" class="text-blue-600 underline font-bold">FILE</a>` : '-'}</td>
                        <td class="p-2 border text-center">${signImg}</td>
                        <td class="p-2 border text-center no-print">${aksi}</td>
                    </tr>`;
            });
        }

        // --- 4. SIGNATURE & NOTIF LOGIC ---
        function openSign(id) { 
            activeId = id; 
            document.getElementById('signModal').classList.remove('hidden'); 
            signPad.clear(); 
        }

        function saveSign() {
            if (signPad.isEmpty()) return alert("Silakan tanda tangan!");
            const img = signPad.toDataURL();
            const updates = {};

            if (userSess.role === 'Verifikator') {
                updates.status = 'VERIFIED';
                updates.signV = img;
            } else if (userSess.role === 'Pimpinan') {
                updates.status = 'FINISHED';
                updates.signP = img;
            }

            dbRef.child(activeId).update(updates).then(() => closeModal());
        }

        function showToast(nama, uraian) {
            const container = document.getElementById('notifContainer');
            const toast = document.createElement('div');
            toast.className = "toast-notif pointer-events-auto bg-white border-l-4 border-blue-600 shadow-2xl p-4 rounded-xl w-72 mb-3 border flex flex-col";
            toast.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="text-[10px] font-black text-blue-600 uppercase">Inputan Baru!</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-black">âœ•</button>
                </div>
                <p class="text-sm font-bold text-slate-800">${nama}</p>
                <p class="text-[11px] text-slate-500 truncate">${uraian}</p>
            `;
            container.appendChild(toast);
            setTimeout(() => { if(toast) toast.remove(); }, 8000);
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.play().catch(() => {});
        }

        function aktifkanNotifRealtime() {
            if (userSess.role === 'Verifikator') {
                let initial = true;
                dbRef.limitToLast(1).on('child_added', (snap) => {
                    if (initial) { initial = false; return; }
                    const d = snap.val();
                    if (d.verifBy === userSess.name && d.status === 'INPUT') {
                        showToast(d.user, d.uraian);
                    }
                });
            }
        }

        // --- 5. HELPERS ---
        function closeModal() { document.getElementById('signModal').classList.add('hidden'); }
        function clearSign() { signPad.clear(); }
        function hapusData(id) { if(confirm("Hapus data ini?")) dbRef.child(id).remove(); }
        function editData(id) {
            const item = db.find(x => x.id == id);
            document.getElementById('editId').value = item.id;
            document.getElementById('inUraian').value = item.uraian;
            document.getElementById('inJml').value = item.jml;
            document.getElementById('inSatuan').value = item.satuan;
            document.getElementById('formTitle').innerText = "Edit Kegiatan";
            window.scrollTo(0,0);
        }
        function resetForm() {
            document.getElementById('editId').value = "";
            document.getElementById('inUraian').value = "";
            document.getElementById('inJml').value = "";
            document.getElementById('inSatuan').value = "";
            document.getElementById('inBerkas').value = "";
            document.getElementById('formTitle').innerText = "Tambah Kegiatan";
        }
    </script>
</body>
</html>

