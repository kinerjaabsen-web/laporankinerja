<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DINARPUS - Laporan Kinerja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Sembunyikan kolom tabel tertentu di HP, tampilkan versi Card */
        @media (max-width: 768px) {
            .desktop-table { display: none; }
            .mobile-card { display: block; }
        }
        @media (min-width: 769px) {
            .mobile-card { display: none; }
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            table { width: 100% !important; border-collapse: collapse; }
            th, td { border: 1px solid black !important; padding: 4px; font-size: 10pt; }
        }

        .print-only { display: none; }
        #signature-pad-canvas { border: 2px dashed #cbd5e1; background: #f8fafc; touch-action: none; }
        
        /* Animasi Notif */
        .toast-notif { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-slate-900">

    <div id="notifContainer" class="fixed bottom-4 left-4 right-4 z-[100] space-y-2 pointer-events-none"></div>

    <div id="loginPage" class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md border-t-8 border-blue-900">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-black text-blue-900 italic uppercase">DINARPUS PW</h1>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Sistem Laporan Kinerja</p>
            </div>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Pilih Nama Anda</label>
                    <select id="userSelect" class="w-full p-4 border-2 rounded-2xl outline-none bg-gray-50 focus:border-blue-500 font-bold text-sm appearance-none">
                        <option value="">-- Pilih User --</option>
                        <optgroup label="PEGAWAI">
                            <option value="Saeful">Saeful</option><option value="Fuad">Fuad</option>
                            <option value="Lusi">Lusi</option><option value="Dadi">Dadi</option>
                            <option value="Widhi">Widhi</option><option value="Eni">Eni</option>
                            <option value="Della">Della</option><option value="Arya">Arya</option>
                            <option value="Ragil">Ragil Aji</option><option value="Parsono">Parsono</option>
                            <option value="Agus">Agus</option><option value="Mijil">Mijil</option>
                            <option value="Dirin">Dirin</option><option value="Toro">Toro</option>
                            <option value="Ana">Ana</option><option value="Mei">Mei</option>
                            <option value="Okta">Okta</option><option value="Bella">Bella</option>
                            <option value="Arfan">Arfan</option><option value="Didid">Didid</option>
                            <option value="Lia">Lia</option><option value="Riono">Riono</option>
                            <option value="Hari">Hari</option><option value="Novi">Novi</option>
                        </optgroup>
                        <optgroup label="VERIFIKATOR / PIMPINAN">
                            <option value="Murti">Murtikowati (Verif)</option>
                            <option value="Itqon">M.Nur Itqon (Verif)</option>
                            <option value="Marliati">Marliati (Verif)</option>
                            <option value="Kepala">Endi Astono (Pimpinan)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Kata Sandi</label>
                    <input type="password" id="passInput" placeholder="••••••" class="w-full p-4 border-2 rounded-2xl outline-none bg-gray-50 focus:border-blue-500 text-center tracking-widest">
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-900 text-white font-bold py-4 rounded-2xl hover:bg-black transition-all shadow-lg active:scale-95 uppercase tracking-widest">Masuk Aplikasi</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden pb-20">
        <nav class="bg-blue-900 text-white p-4 sticky top-0 z-40 shadow-lg no-print">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="leading-tight">
                    <p id="displayUser" class="font-black text-sm uppercase"></p>
                    <p id="displayRole" class="text-[9px] text-blue-300 font-bold uppercase"></p>
                </div>
                <button onclick="handleLogout()" class="bg-red-500/20 hover:bg-red-500 text-red-200 hover:text-white px-3 py-1.5 rounded-xl text-[10px] font-bold transition-all border border-red-500/50">LOGOUT</button>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
            
            <div id="formPegawai" class="hidden bg-white p-5 rounded-3xl shadow-md no-print border border-slate-200">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-2 h-6 bg-blue-700 rounded-full"></div>
                    <h2 id="formTitle" class="font-black text-slate-800 uppercase text-xs tracking-widest">Tambah Kegiatan</h2>
                </div>
                <p class="text-[10px] bg-red-50 text-red-600 p-2 rounded-lg font-bold mb-4 border border-red-100 uppercase italic">⚠️ Batas Input: Hari ini maks jam 16.00 WIB</p>
                
                <input type="hidden" id="editId">
                <div class="grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Tanggal</label>
                            <input type="date" id="inTgl" class="w-full p-3 border rounded-xl text-sm bg-gray-100 font-bold" readonly>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Volume & Satuan</label>
                            <div class="flex gap-1">
                                <input type="number" id="inJml" placeholder="Jml" class="w-16 p-3 border rounded-xl text-sm bg-slate-50 focus:border-blue-500 outline-none">
                                <input type="text" id="inSatuan" placeholder="Satuan" class="w-full p-3 border rounded-xl text-sm bg-slate-50 focus:border-blue-500 outline-none uppercase font-bold text-[10px]">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Uraian Kegiatan</label>
                        <textarea id="inUraian" rows="3" placeholder="Apa saja yang dikerjakan hari ini..." class="w-full p-3 border rounded-xl text-sm bg-slate-50 outline-none focus:border-blue-500"></textarea>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Unggah Bukti (Opsional)</label>
                        <input type="file" id="inBerkas" class="w-full text-xs p-2 border border-dashed rounded-xl bg-slate-50">
                    </div>
                    <button onclick="submitLaporan()" class="w-full bg-blue-700 text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg shadow-blue-200 active:scale-95">Simpan Data</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border no-print flex flex-col md:flex-row gap-3">
                <div class="flex-1 grid grid-cols-2 gap-2">
                    <input type="date" id="filterStart" class="p-2 border rounded-xl text-xs bg-slate-50 font-bold">
                    <input type="date" id="filterEnd" class="p-2 border rounded-xl text-xs bg-slate-50 font-bold">
                </div>
                <div class="flex gap-2">
                    <button onclick="renderTable()" class="flex-1 bg-blue-900 text-white p-2 rounded-xl text-xs font-bold uppercase">Filter</button>
                    <button onclick="window.print()" class="bg-emerald-600 text-white p-2 rounded-xl text-xs font-bold uppercase">Cetak PDF</button>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border">
                <div class="p-4 md:p-6">
                    <table class="desktop-table w-full text-xs text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-500 uppercase font-black border-b">
                            <tr>
                                <th class="p-3">Nama</th>
                                <th class="p-3">Tgl</th>
                                <th class="p-3">Uraian</th>
                                <th class="p-3 text-center">Bukti</th>
                                <th class="p-3 text-center">Status</th>
                                <th class="p-3 text-center no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyDesktop"></tbody>
                    </table>

                    <div id="tableBodyMobile" class="mobile-card space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="signModal" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl">
            <h3 class="text-sm font-black mb-4 uppercase tracking-widest text-blue-900 italic">Silakan Tanda Tangan</h3>
            <canvas id="signature-pad-canvas" width="300" height="200" class="w-full rounded-2xl mb-4"></canvas>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="clearSign()" class="bg-gray-100 py-3 rounded-xl text-[10px] font-black uppercase">Ulangi</button>
                <button onclick="saveSign()" class="bg-blue-800 text-white py-3 rounded-xl text-[10px] font-black uppercase">Simpan</button>
            </div>
            <button onclick="closeModal()" class="mt-4 text-red-500 text-[10px] font-bold uppercase tracking-tighter">✕ Tutup / Batal</button>
        </div>
    </div>

    <script>
        // --- DATA & FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAi6r89ZlhtZ325z3ypGQhrKUdq-mHXNCs",
            authDomain: "laporankinerja-fa09e.firebaseapp.com",
            databaseURL: "https://laporankinerja-fa09e-default-rtdb.firebaseio.com",
            projectId: "laporankinerja-fa09e",
            storageBucket: "laporankinerja-fa09e.firebasestorage.app",
            messagingSenderId: "1034616765062",
            appId: "1:1034616765062:web:ad66fa6c34dfadcec52f07"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('dinarpus_db');

        const config = {
            'Murti': { role: 'Verifikator', pass: '12345' }, 'Marliati': { role: 'Verifikator', pass: '12345' }, 'Itqon': { role: 'Verifikator', pass: '12345' }, 'Kepala': { role: 'Pimpinan', pass: '123456' },
            'Saeful': { role: 'Pegawai', verif: 'Murti', pass: '123' }, 'Fuad': { role: 'Pegawai', verif: 'Murti', pass: '123' }, 'Lusi': { role: 'Pegawai', verif: 'Murti', pass: '123' }, 'Dadi': { role: 'Pegawai', verif: 'Murti', pass: '123' }, 'Widhi': { role: 'Pegawai', verif: 'Murti', pass: '123' }, 'Eni': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Arya': { role: 'Pegawai', verif: 'Marliati', pass: '123' }, 'Della': { role: 'Pegawai', verif: 'Marliati', pass: '123' }, 'Novi': { role: 'Pegawai', verif: 'Marliati', pass: '123' }, 'Parsono': { role: 'Pegawai', verif: 'Marliati', pass: '123' }, 'Riono': { role: 'Pegawai', verif: 'Marliati', pass: '123' }, 'Hari': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Agus': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Mijil': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Dirin': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Toro': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Ana': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Mei': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Okta': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Bella': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Arfan': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Didid': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Lia': { role: 'Pegawai', verif: 'Itqon', pass: '123' }, 'Ragil': { role: 'Pegawai', verif: 'Itqon', pass: '123' }
        };

        let db = [], userSess = null, signPad = null, activeId = null;

        // --- CORE ---
        document.addEventListener('DOMContentLoaded', () => {
            signPad = new SignaturePad(document.getElementById('signature-pad-canvas'));
            const saved = localStorage.getItem('dinarpus_session');
            if (saved) { userSess = JSON.parse(saved); renderDashboard(); }
        });

        function handleLogin() {
            const user = document.getElementById('userSelect').value;
            const pass = document.getElementById('passInput').value;
            if (!user || pass !== config[user].pass) return alert("Pilih Nama & Password yang benar!");
            userSess = { name: user, ...config[user] };
            localStorage.setItem('dinarpus_session', JSON.stringify(userSess));
            renderDashboard();
        }

        function handleLogout() { localStorage.removeItem('dinarpus_session'); location.reload(); }

        function renderDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('displayUser').innerText = userSess.name;
            document.getElementById('displayRole').innerText = userSess.role;
            if (userSess.role === 'Pegawai') {
                document.getElementById('formPegawai').classList.remove('hidden');
                document.getElementById('inTgl').value = new Date().toISOString().split('T')[0];
            }
            muatDataOnline();
            aktifkanNotifRealtime();
        }

        function muatDataOnline() {
            dbRef.on('value', (snap) => {
                const data = snap.val();
                db = data ? Object.values(data) : [];
                renderTable();
            });
        }

        function submitLaporan() {
            const skr = new Date();
            if (skr.getHours() >= 16) return alert("Maaf, sudah lewat jam 16.00 WIB.");

            const editId = document.getElementById('editId').value;
            const file = document.getElementById('inBerkas').files[0];

            const save = (base64 = "") => {
                const id = editId || Date.now();
                const cur = editId ? db.find(x => x.id == editId) : null;
                const data = {
                    id: id, user: userSess.name, verifBy: userSess.verif || '',
                    tgl: document.getElementById('inTgl').value,
                    uraian: document.getElementById('inUraian').value,
                    jml: document.getElementById('inJml').value,
                    satuan: document.getElementById('inSatuan').value,
                    status: cur ? cur.status : 'INPUT',
                    signV: cur ? (cur.signV || '') : '', signP: cur ? (cur.signP || '') : '',
                    berkas: base64 || (cur ? cur.berkas : '')
                };
                dbRef.child(id).set(data).then(() => { alert("Tersimpan!"); resetForm(); });
            };

            if (file) {
                const r = new FileReader(); r.readAsDataURL(file);
                r.onload = () => save(r.result);
            } else save();
        }

        function renderTable() {
            const bodyDesktop = document.getElementById('tableBodyDesktop');
            const bodyMobile = document.getElementById('tableBodyMobile');
            const fS = document.getElementById('filterStart').value;
            const fE = document.getElementById('filterEnd').value;
            
            bodyDesktop.innerHTML = '';
            bodyMobile.innerHTML = '';

            db.filter(i => {
                const rM = (userSess.role === 'Pegawai') ? (i.user === userSess.name) : (userSess.role === 'Verifikator') ? (i.verifBy === userSess.name) : true;
                const dM = (fS && fE) ? (i.tgl >= fS && i.tgl <= fE) : true;
                return rM && dM;
            }).sort((a,b) => b.id - a.id).forEach((i, idx) => {
                let aksi = '', signImg = '<span class="text-gray-300 italic">...</span>';
                if (i.status === 'VERIFIED') signImg = `<img src="${i.signV}" class="h-8 mx-auto">`;
                if (i.status === 'FINISHED') signImg = `<img src="${i.signP}" class="h-8 mx-auto">`;

                if (userSess.role === 'Pegawai' && i.status === 'INPUT') {
                    aksi = `<div class="flex gap-2"><button onclick="editData(${i.id})" class="flex-1 bg-blue-100 text-blue-700 p-2 rounded-lg font-bold">Edit</button><button onclick="hapusData(${i.id})" class="flex-1 bg-red-100 text-red-700 p-2 rounded-lg font-bold">Hapus</button></div>`;
                } else if (userSess.role === 'Verifikator' && i.status === 'INPUT') {
                    aksi = `<button onclick="openSign(${i.id})" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">VERIFIKASI</button>`;
                } else if (userSess.role === 'Pimpinan' && i.status === 'VERIFIED') {
                    aksi = `<button onclick="openSign(${i.id})" class="w-full bg-emerald-600 text-white p-3 rounded-xl font-bold">TTD PIMPINAN</button>`;
                }

                // Render Desktop
                bodyDesktop.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3 font-bold">${i.user}</td>
                        <td class="p-3">${i.tgl}</td>
                        <td class="p-3 whitespace-pre-wrap">${i.uraian}</td>
                        <td class="p-3 text-center">${i.berkas ? `<a href="${i.berkas}" download class="text-blue-600 font-bold">LIHAT</a>` : '-'}</td>
                        <td class="p-3 text-center">${signImg}</td>
                        <td class="p-3 text-center no-print">${aksi}</td>
                    </tr>`;

                // Render Mobile Card
                bodyMobile.innerHTML += `
                    <div class="bg-slate-50 p-4 rounded-2xl border-2 border-white shadow-sm space-y-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[9px] font-black text-slate-400 uppercase">${i.tgl}</p>
                                <p class="font-black text-blue-900 uppercase">${i.user}</p>
                            </div>
                            <div class="text-right">${signImg}</div>
                        </div>
                        <p class="text-xs text-slate-600 whitespace-pre-wrap leading-relaxed bg-white p-3 rounded-xl border border-slate-100">${i.uraian}</p>
                        <div class="flex justify-between items-center py-2 border-t border-dashed">
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Volume: ${i.jml} ${i.satuan}</p>
                            ${i.berkas ? `<a href="${i.berkas}" download class="text-[10px] bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-bold">BUKTI FILE</a>` : ''}
                        </div>
                        <div class="no-print pt-2">${aksi}</div>
                    </div>`;
            });
        }

        // --- NOTIF & SIGN ---
        function openSign(id) { activeId = id; document.getElementById('signModal').classList.remove('hidden'); signPad.clear(); }
        function closeModal() { document.getElementById('signModal').classList.add('hidden'); }
        function clearSign() { signPad.clear(); }
        function saveSign() {
            if (signPad.isEmpty()) return alert("Tanda tangan dulu!");
            const img = signPad.toDataURL(), up = {};
            if (userSess.role === 'Verifikator') { up.status = 'VERIFIED'; up.signV = img; }
            else if (userSess.role === 'Pimpinan') { up.status = 'FINISHED'; up.signP = img; }
            dbRef.child(activeId).update(up).then(() => closeModal());
        }

        function showToast(nama, uraian) {
            const container = document.getElementById('notifContainer');
            const toast = document.createElement('div');
            toast.className = "toast-notif pointer-events-auto bg-blue-900 text-white p-4 rounded-2xl shadow-2xl border border-blue-700 flex flex-col";
            toast.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[9px] font-black text-blue-300 uppercase">Laporan Masuk Baru</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white">✕</button>
                </div>
                <p class="text-xs font-bold">${nama}</p>
                <p class="text-[10px] opacity-70 truncate">${uraian}</p>
            `;
            container.appendChild(toast);
            setTimeout(() => { if(toast) toast.remove(); }, 6000);
            new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{});
        }

        function aktifkanNotifRealtime() {
            if (userSess.role === 'Verifikator') {
                let init = true;
                dbRef.limitToLast(1).on('child_added', snap => {
                    if (init) { init = false; return; }
                    const d = snap.val();
                    if (d.verifBy === userSess.name && d.status === 'INPUT') showToast(d.user, d.uraian);
                });
            }
        }

        function hapusData(id) { if(confirm("Hapus?")) dbRef.child(id).remove(); }
        function editData(id) {
            const itm = db.find(x => x.id == id);
            document.getElementById('editId').value = itm.id;
            document.getElementById('inUraian').value = itm.uraian;
            document.getElementById('inJml').value = itm.jml;
            document.getElementById('inSatuan').value = itm.satuan;
            document.getElementById('formTitle').innerText = "Edit Data";
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
        function resetForm() {
            document.getElementById('editId').value = "";
            document.getElementById('inUraian').value = "";
            document.getElementById('inJml').value = "";
            document.getElementById('inSatuan').value = "";
            document.getElementById('inBerkas').value = "";
            document.getElementById('formTitle').innerText = "Tambah Kegiatan";
        }
    </script>
</body>
</html>
