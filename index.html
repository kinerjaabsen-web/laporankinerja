<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DINARPUS - Sistem Laporan Kinerja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; padding: 0; margin: 0; }
            .signature-wrapper { display: flex !important; flex-direction: row !important; justify-content: space-between !important; margin-top: 50px; }
            .signature-box { width: 45% !important; text-align: center; }
            
            /* Penyesuaian Lebar Kolom PDF */
            table { width: 100% !important; border-collapse: collapse; table-layout: fixed; }
            th, td { border: 1px solid black !important; padding: 8px !important; word-wrap: break-word; overflow-wrap: break-word; }
            .col-no { width: 30px; }
            .col-nama { width: 80px; }
            .col-tgl { width: 80px; }
            .col-uraian { width: 60% !important; } /* Kolom uraian diperlebar */
            .col-vol { width: 70px; }
            .col-bukti { width: 50px; }
            .col-status { width: 100px; }
        }

        .print-only { display: none; }
        #signature-pad-canvas { border: 2px dashed #cbd5e1; background: #f8fafc; cursor: crosshair; }
        .signature-img { max-height: 80px; mix-blend-mode: multiply; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.2; } }

        /* Style untuk Running Text */
        .marquee-container {
            background: #fef3c7;
            border-bottom: 1px solid #fcd34d;
            padding: 6px 0;
            overflow: hidden;
            white-space: nowrap;
        }
        .marquee-text {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
            font-weight: 800;
            font-size: 12px;
            color: #92400e;
            text-transform: uppercase;
        }
        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">

    <div id="notifContainer" class="fixed bottom-5 right-5 z-[100] space-y-3 pointer-events-none"></div>

    <div id="loginPage" class="flex items-center justify-center min-h-screen no-print px-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border-t-8 border-blue-900">
            <h1 class="text-3xl font-black text-blue-900 text-center mb-6 italic uppercase leading-tight">Laporan Kinerja<br>PPPK PW</h1>
            <div class="space-y-4">
                <select id="userSelect" class="w-full p-3 border rounded-xl outline-none bg-gray-50 focus:ring-2 focus:ring-blue-500 font-bold text-sm text-black">
                    <option value="">-- Pilih User --</option>
                    <option value="Saeful">Saeful (Pegawai)</option>
                    <option value="Fuad">Fuad (Pegawai)</option>
                    <option value="Lusi">Lusi (Pegawai)</option>
                    <option value="Dadi">Dadi (Pegawai)</option>
                    <option value="Widhi">Widhi (Pegawai)</option>
                    <option value="Eni">Eni (Pegawai)</option>
                    <option value="Della">Della (Pegawai)</option>
                    <option value="Arya">Arya (Pegawai)</option>
                    <option value="Ragil">Ragil Aji (Pegawai)</option>
                    <option value="Parsono">Parsono (Pegawai)</option>
                    <option value="Agus">Agus (Pegawai)</option>
                    <option value="Mijil">Mijil (Pegawai)</option>
                    <option value="Dirin">Dirin (Pegawai)</option>
                    <option value="Toro">Toro (Pegawai)</option>
                    <option value="Ana">Ana (Pegawai)</option>
                    <option value="Mei">Mei (Pegawai)</option>
                    <option value="Okta">Okta (Pegawai)</option>
                    <option value="Bella">Bella (Pegawai)</option>
                    <option value="Arfan">Arfan (Pegawai)</option>
                    <option value="Didid">Didid (Pegawai)</option>
                    <option value="Lia">Lia (Pegawai)</option>
                    <option value="Riono">Riono (Pegawai)</option>
                    <option value="Hari">Hari (Pegawai)</option>
                    <option value="Novi">Novi (Pegawai)</option>
                    <option value="Murti">Murtikowati (Verifikator)</option>
                    <option value="Itqon">M.Nur Itqon (Verifikator)</option>
                    <option value="Marliati">Marliati (Verifikator)</option>
                    <option value="Kepala">Endi Astono (Pimpinan)</option>
                </select>
                <input type="password" id="passInput" placeholder="Password" class="w-full p-3 border rounded-xl outline-none bg-gray-50 focus:ring-2 focus:ring-blue-500 text-sm">
                <button onclick="handleLogin()" class="w-full bg-blue-900 text-white font-bold py-3 rounded-xl hover:bg-black transition shadow-lg">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden flex-1">
        <nav class="bg-blue-900 text-white p-4 no-print flex justify-between items-center shadow-md">
            <div class="font-black text-xl italic tracking-tighter uppercase">DINARPUS PW 2026</div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p id="displayUser" class="text-xs font-bold"></p>
                    <p id="displayRole" class="text-[10px] text-blue-300 uppercase font-black"></p>
                </div>
                <div class="flex gap-1">
                    <button onclick="togglePasswordModal()" class="bg-amber-500 p-2 rounded-lg text-[9px] font-bold text-white uppercase">Ganti Pass</button>
                    <button onclick="handleLogout()" class="bg-red-500 p-2 rounded-lg text-[9px] font-bold text-white uppercase">Logout</button>
                </div>
            </div>
        </nav>

        <div class="no-print marquee-container">
            <div class="marquee-text">
                PENGUMUMAN: SISTEM LAPORAN KINERJA HARIAN AKAN DITUTUP OTOMATIS PADA PUKUL 16:15 WIB SETIAP HARINYA. PASTIKAN SEMUA KEGIATAN SUDAH TERINPUT SEBELUM JAM TERSEBUT. TERIMAKASIH.
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-4 md:p-8">
            <div id="trackingStatus" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-orange-400">
                    <p class="text-[10px] font-black text-gray-400 uppercase">Menunggu Verifikasi</p>
                    <p id="countInput" class="text-2xl font-black text-orange-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-[10px] font-black text-gray-400 uppercase">Sudah Diverifikasi</p>
                    <p id="countVerified" class="text-2xl font-black text-blue-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-[10px] font-black text-gray-400 uppercase">Selesai (Final)</p>
                    <p id="countFinished" class="text-2xl font-black text-emerald-600">0</p>
                </div>
            </div>

            <div id="timerContainer" class="hidden no-print mb-6 bg-white p-5 rounded-2xl shadow-sm border flex items-center justify-between">
                <div>
                    <span class="text-[10px] font-black text-slate-400 uppercase block tracking-widest leading-none mb-1">Sisa Waktu Input Hari Ini:</span>
                    <span id="systemStatusText" class="font-bold text-xs text-emerald-600 uppercase">Sistem Terbuka</span>
                </div>
                <div class="text-right">
                    <span id="countdownDisplay" class="font-black text-3xl tabular-nums text-blue-900 tracking-tighter">00:00:00</span>
                    <p class="text-[9px] font-bold text-slate-400 uppercase">Deadline: 16:15 WIB</p>
                </div>
            </div>

            <div id="formPegawai" class="hidden bg-white p-6 rounded-2xl shadow-sm mb-6 no-print border-l-8 border-blue-700">
                <div id="inputActive">
                    <h2 id="formTitle" class="font-bold text-slate-800 mb-4 uppercase text-xs tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></span> Tambah Kegiatan
                    </h2>
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Tanggal</label>
                            <input type="date" id="inTgl" class="w-full border p-3 rounded-xl text-sm bg-slate-50 mt-1 outline-none">
                        </div>
                        <div class="md:col-span-3">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Uraian Kegiatan</label>
                            <textarea id="inUraian" rows="3" class="w-full border p-3 rounded-xl text-sm bg-slate-50 mt-1 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Vol & Satuan</label>
                            <div class="flex gap-2 mt-1">
                                <input type="number" id="inJml" placeholder="Jml" class="border p-3 rounded-xl text-sm w-20 bg-slate-50">
                                <input type="text" id="inSatuan" placeholder="Satuan" class="border p-3 rounded-xl text-sm w-full bg-slate-50">
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Upload Bukti</label>
                            <input type="file" id="inBerkas" class="w-full text-xs mt-1 border p-2 rounded-xl bg-slate-50">
                        </div>
                        <div class="flex items-end">
                            <button onclick="submitLaporan()" class="w-full bg-blue-700 text-white py-3 rounded-xl font-bold uppercase shadow-md hover:bg-black transition">Simpan Laporan</button>
                        </div>
                    </div>
                </div>
                <div id="inputLocked" class="hidden text-center py-10 bg-red-50 rounded-2xl border-2 border-dashed border-red-200">
                    <p class="text-4xl mb-3">ðŸ”’</p>
                    <h2 class="text-red-600 font-black text-xl uppercase italic leading-none">Sistem Terkunci Otomatis</h2>
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-2">Batas pengisian jam 16:15 WIB telah berakhir.</p>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border p-4 md:p-8 mb-10">
                <div class="no-print flex flex-wrap gap-3 mb-6 items-end border-b pb-6">
                    <div class="flex-1 min-w-[150px]">
                        <label class="text-[10px] font-black text-gray-400 uppercase">Periode</label>
                        <div class="flex gap-2">
                            <input type="date" id="filterStart" class="w-full border p-2 rounded-xl text-sm">
                            <input type="date" id="filterEnd" class="w-full border p-2 rounded-xl text-sm">
                        </div>
                    </div>
                    <button onclick="renderTable()" class="bg-blue-800 text-white px-6 py-2 rounded-xl font-bold text-sm uppercase">Cari</button>
                    <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold text-sm uppercase italic">Cetak PDF</button>
                </div>

                <div class="print-only text-center border-b-4 border-double border-black pb-4 mb-8">
                    <h1 class="text-2xl font-black uppercase">LAPORAN KINERJA HARIAN PPPK PARUH WAKTU</h1>
                    <h2 class="text-lg font-bold uppercase leading-tight">DINAS KEARSIPAN DAN PERPUSTAKAAN KABUPATEN PURBALINGGA</h2>
                </div>

                <table class="w-full text-[11px] text-left border-collapse border">
                    <thead>
                        <tr class="bg-slate-800 text-white uppercase font-black border">
                            <th class="p-3 border text-center col-no">No</th>
                            <th class="p-2 border col-nama">Nama</th>
                            <th class="p-2 border col-tgl">Tanggal</th>
                            <th class="p-3 border col-uraian">Uraian Kegiatan</th>
                            <th class="p-3 border text-center col-vol">Volume</th>
                            <th class="p-3 border text-center col-bukti">Bukti</th>
                            <th class="p-3 border text-center col-status">Status & Paraf</th>
                            <th class="p-3 border text-center no-print w-24">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>

                <div class="print-only signature-wrapper mt-12">
                    <div class="signature-box">
                        <p class="text-[10px] font-bold uppercase">Mengetahui/Memverifikasi,</p>
                        <div class="h-20 flex items-center justify-center">
                            <img id="printSignVerif" class="signature-img mx-auto">
                        </div>
                        <p id="printNameVerif" class="font-bold underline uppercase text-sm mt-2"></p>
                        <p id="printNipVerif" class="text-[10px] font-bold uppercase"></p>
                    </div>
                    <div class="signature-box">
                        <p class="text-[10px] font-bold uppercase">Kepala Dinas Kearsipan dan Perpustakaan,</p>
                        <div class="h-20 flex items-center justify-center">
                            <img id="printSignPimpinan" class="signature-img mx-auto">
                        </div>
                        <p class="font-bold underline uppercase text-sm mt-2">ENDI ASTONO, S.Sos</p>
                        <p class="text-[10px] font-bold uppercase leading-tight">Pembina Utama Muda <br>NIP. 196709191990031010</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="passModal" class="fixed inset-0 bg-black/70 hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs text-center shadow-2xl">
            <h3 class="text-lg font-bold mb-4 uppercase italic text-blue-900">Ganti Password</h3>
            <input type="password" id="newPass" placeholder="Masukkan Password Baru" class="w-full p-3 border rounded-xl mb-4 text-sm outline-none focus:ring-2 focus:ring-amber-500">
            <div class="flex flex-col gap-2">
                <button onclick="updatePassword()" class="bg-amber-500 text-white py-3 rounded-xl font-bold uppercase shadow-lg">Simpan Baru</button>
                <button onclick="togglePasswordModal()" class="text-slate-400 text-xs font-bold uppercase py-2 underline">Batal</button>
            </div>
        </div>
    </div>

    <div id="signModal" class="fixed inset-0 bg-black/70 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md text-center">
            <h3 class="text-lg font-bold mb-4 uppercase italic">Tanda Tangan Digital</h3>
            <canvas id="signature-pad-canvas" width="400" height="200" class="w-full rounded-lg border-2 border-dashed"></canvas>
            <div class="flex gap-2 mt-4">
                <button onclick="clearSign()" class="bg-gray-100 px-4 py-2 rounded-xl text-[10px] font-bold uppercase">Ulangi</button>
                <button onclick="saveSign()" class="bg-blue-800 text-white flex-1 py-2 rounded-xl font-bold uppercase">Simpan TTD</button>
                <button onclick="closeSignModal()" class="text-red-500 text-xs font-bold uppercase px-2">Batal</button>
            </div>
        </div>
    </div>

    <footer class="no-print w-full py-6 mt-auto text-center border-t bg-white">
        <p class="text-slate-400 text-[11px] font-bold tracking-widest uppercase">
            Copyright &copy; 2026 <span class="text-blue-900">Sae Development</span>
        </p>
    </footer>

    <script>
        // Firebase Config & Config User tetap sama
        const firebaseConfig = {
            apiKey: "AIzaSyAi6r89ZlhtZ325z3ypGQhrKUdq-mHXNCs",
            authDomain: "laporankinerja-fa09e.firebaseapp.com",
            databaseURL: "https://laporankinerja-fa09e-default-rtdb.firebaseio.com",
            projectId: "laporankinerja-fa09e",
            storageBucket: "laporankinerja-fa09e.firebasestorage.app",
            messagingSenderId: "1034616765062",
            appId: "1:1034616765062:web:ad66fa6c34dfadcec52f07"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('dinarpus_db');
        const passRef = firebase.database().ref('dinarpus_passwords');

        const config = {
            'Murti': { role: 'Verifikator', pass: '12345', full: 'MURTIKOWATI, S.Sos', nip: 'NIP. 197210151998032006' },
            'Marliati': { role: 'Verifikator', pass: '12345', full: 'MARLIATI, S.Sos', nip: 'NIP. 196803131994032010' },
            'Itqon': { role: 'Verifikator', pass: '12345', full: 'M. NUR ITQON, S.T', nip: 'NIP. 197805212010011009' },
            'Kepala': { role: 'Pimpinan', pass: '123456' },
            'Saeful': { role: 'Pegawai', verif: 'Murti', pass: 's123' },
            'Fuad': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Lusi': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Dadi': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Widhi': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Eni': { role: 'Pegawai', verif: 'Murti', pass: '123' },
            'Arya': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Della': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Novi': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Parsono': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Riono': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Hari': { role: 'Pegawai', verif: 'Marliati', pass: '123' },
            'Agus': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Mijil': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Dirin': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Toro': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Ana': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Mei': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Okta': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Bella': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Arfan': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Didid': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Lia': { role: 'Pegawai', verif: 'Itqon', pass: '123' },
            'Ragil': { role: 'Pegawai', verif: 'Itqon', pass: '123' }
        };

        let db = [], userSess = null, signPad = null, activeId = null;

        document.addEventListener('DOMContentLoaded', () => {
            signPad = new SignaturePad(document.getElementById('signature-pad-canvas'));
            const saved = localStorage.getItem('dinarpus_session');
            if (saved) { userSess = JSON.parse(saved); renderDashboard(); }
            setInterval(updateCountdown, 1000);
        });

        // 8. Logika Waktu Mundur (Countdown) - DIUBAH KE 16:15
        function updateCountdown() {
            if (!userSess) return;
            const now = new Date();
            const target = new Date(); 
            target.setHours(16, 15, 0, 0); // Diubah ke jam 16:15
            const diff = target - now;

            const display = document.getElementById('countdownDisplay');
            const statusText = document.getElementById('systemStatusText');
            const inputActive = document.getElementById('inputActive');
            const inputLocked = document.getElementById('inputLocked');
            
            document.getElementById('timerContainer').classList.remove('hidden');

            if (diff <= 0) {
                display.innerText = "00:00:00";
                display.className = "font-black text-3xl tabular-nums text-slate-300 tracking-tighter";
                statusText.innerText = "Sistem Terkunci";
                statusText.className = "font-bold text-xs text-red-600 uppercase";
                if (userSess.role === 'Pegawai') {
                    inputActive.classList.add('hidden');
                    inputLocked.classList.remove('hidden');
                }
                return;
            }

            const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
            display.innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;

            if (diff < 1800000) { // < 30 Menit (Indikator Bahaya)
                display.classList.add('text-red-600', 'blink');
                statusText.innerText = "Sistem Segera Dikunci!";
                statusText.classList.replace('text-emerald-600', 'text-red-600');
            }
        }

        // Fungsi lainnya tetap sama
        function togglePasswordModal() { document.getElementById('passModal').classList.toggle('hidden'); }
        function updatePassword() {
            const val = document.getElementById('newPass').value;
            if(val.length < 3) return alert("Minimal 3 karakter!");
            passRef.child(userSess.name).set(val).then(() => {
                alert("Password Diganti! SIlakan Login Ulang.");
                handleLogout();
            });
        }

        async function handleLogin() {
            const user = document.getElementById('userSelect').value;
            const pass = document.getElementById('passInput').value;
            if (!user) return alert("Pilih User!");
            const snap = await passRef.child(user).once('value');
            const correctPass = snap.val() || config[user].pass;
            if (pass !== correctPass) return alert("Password Salah!");
            userSess = { name: user, ...config[user] };
            localStorage.setItem('dinarpus_session', JSON.stringify(userSess));
            renderDashboard();
        }

        function handleLogout() { localStorage.removeItem('dinarpus_session'); location.reload(); }

        function renderDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('displayUser').innerText = userSess.name;
            document.getElementById('displayRole').innerText = userSess.role;
            if (userSess.role === 'Pegawai') {
                document.getElementById('formPegawai').classList.remove('hidden');
                document.getElementById('inTgl').value = new Date().toISOString().split('T')[0];
            }
            muatDataOnline();
        }

        function muatDataOnline() {
            dbRef.on('value', snap => {
                db = snap.val() ? Object.values(snap.val()) : [];
                renderTable();
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const fStart = document.getElementById('filterStart').value;
            const fEnd = document.getElementById('filterEnd').value;
            tbody.innerHTML = '';

            let dataFilter = db.filter(i => {
                const rM = (userSess.role === 'Pegawai') ? (i.user === userSess.name) :
                           (userSess.role === 'Verifikator') ? (i.verifBy === userSess.name) : true;
                const dM = (fStart && fEnd) ? (i.tgl >= fStart && i.tgl <= fEnd) : true;
                return rM && dM;
            }).sort((a,b) => b.id - a.id);

            let cInput = 0, cVerified = 0, cFinished = 0;

            dataFilter.forEach((i, idx) => {
                if (i.status === 'INPUT') cInput++;
                else if (i.status === 'VERIFIED') cVerified++;
                else if (i.status === 'FINISHED') cFinished++;

                let statusBadge = '';
                if (i.status === 'INPUT') statusBadge = '<span class="text-orange-500 font-bold uppercase text-[9px]">Menunggu Verif</span>';
                else if (i.status === 'VERIFIED') statusBadge = `<div class="flex flex-col items-center"><span class="text-blue-600 font-bold text-[8px] uppercase">Terverifikasi</span><img src="${i.signV}" class="h-8"></div>`;
                else if (i.status === 'FINISHED') statusBadge = `<div class="flex flex-col items-center"><span class="text-emerald-600 font-bold text-[8px] uppercase">Selesai (Final)</span><img src="${i.signP}" class="h-8"></div>`;

                let btn = (userSess.role === 'Pegawai' && i.status === 'INPUT') ? `<button onclick="editData(${i.id})" class="text-blue-600 mr-2">Edit</button><button onclick="hapusData(${i.id})" class="text-red-600">Hapus</button>` : 
                          (userSess.role === 'Verifikator' && i.status === 'INPUT') ? `<button onclick="openSign(${i.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold">Setujui</button>` :
                          (userSess.role === 'Pimpinan' && i.status === 'VERIFIED') ? `<button onclick="openSign(${i.id})" class="bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold">TTD KADIN</button>` : '';

                tbody.innerHTML += `
                    <tr class="border hover:bg-slate-50">
                        <td class="p-3 border text-center font-bold col-no">${idx+1}</td>
                        <td class="p-2 border font-bold text-blue-900 col-nama">${i.user}</td>
                        <td class="p-2 border col-tgl">${i.tgl}</td>
                        <td class="p-2 border whitespace-pre-wrap col-uraian">${i.uraian}</td>
                        <td class="p-2 border text-center font-bold col-vol">${i.jml} ${i.satuan}</td>
                        <td class="p-2 border text-center col-bukti">${i.berkas ? `<a href="${i.berkas}" download class="text-blue-600 font-bold underline">FILE</a>` : '-'}</td>
                        <td class="p-2 border text-center col-status">${statusBadge}</td>
                        <td class="p-2 border text-center no-print">${btn}</td>
                    </tr>`;

                if(i.verifBy && config[i.verifBy]) {
                    document.getElementById('printNameVerif').innerText = config[i.verifBy].full;
                    document.getElementById('printNipVerif').innerText = config[i.verifBy].nip;
                    if(i.signV) document.getElementById('printSignVerif').src = i.signV;
                }
                if(i.status === 'FINISHED') document.getElementById('printSignPimpinan').src = i.signP;
            });

            document.getElementById('countInput').innerText = cInput;
            document.getElementById('countVerified').innerText = cVerified;
            document.getElementById('countFinished').innerText = cFinished;
        }

        function submitLaporan() {
            const editId = document.getElementById('editId').value;
            const file = document.getElementById('inBerkas').files[0];
            const executeSave = (img = "") => {
                const id = editId || Date.now();
                const cur = editId ? db.find(x => x.id == editId) : null;
                const data = {
                    id: id, user: userSess.name, verifBy: userSess.verif || (cur ? cur.verifBy : ''),
                    tgl: document.getElementById('inTgl').value, uraian: document.getElementById('inUraian').value,
                    jml: document.getElementById('inJml').value, satuan: document.getElementById('inSatuan').value,
                    status: cur ? cur.status : 'INPUT', signV: cur ? (cur.signV || '') : '', signP: cur ? (cur.signP || '') : '', berkas: img || (cur ? cur.berkas : '')
                };
                dbRef.child(id).set(data).then(() => { alert("Laporan Disimpan!"); resetForm(); });
            };
            if (file) { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => executeSave(r.result); }
            else executeSave();
        }

        function openSign(id) { activeId = id; document.getElementById('signModal').classList.remove('hidden'); signPad.clear(); }
        function closeSignModal() { document.getElementById('signModal').classList.add('hidden'); }
        function clearSign() { signPad.clear(); }
        function saveSign() {
            const img = signPad.toDataURL();
            const up = userSess.role === 'Verifikator' ? { status:'VERIFIED', signV:img } : { status:'FINISHED', signP:img };
            dbRef.child(activeId).update(up).then(() => closeSignModal());
        }

        function hapusData(id) { if(confirm("Hapus Data Ini?")) dbRef.child(id).remove(); }
        function editData(id) {
            const item = db.find(x => x.id == id);
            document.getElementById('editId').value = item.id;
            document.getElementById('inTgl').value = item.tgl;
            document.getElementById('inUraian').value = item.uraian;
            document.getElementById('inJml').value = item.jml;
            document.getElementById('inSatuan').value = item.satuan;
            document.getElementById('formTitle').innerText = "Edit Laporan";
            window.scrollTo(0,0);
        }

        function resetForm() {
            document.getElementById('editId').value = "";
            document.getElementById('inUraian').value = "";
            document.getElementById('inJml').value = "";
            document.getElementById('inSatuan').value = "";
            document.getElementById('inBerkas').value = "";
            document.getElementById('formTitle').innerText = "Tambah Kegiatan";
        }
    </script>
</body>
</html>
